#!/bin/sh
set -e
ROOTDIR=$(cd $(dirname $0)/../ && pwd -P)
cd $ROOTDIR

package=src/main/java/org/openobservatory/measurement_kit/nettests
now=`date -u +%Y-%m-%d-T%H:%M:%SZ`

for t in                                                                       \
  DashTest                                                                     \
  DnsInjectionTest                                                             \
  FacebookMessengerTest                                                        \
  HttpHeaderFieldManipulationTest                                              \
  HttpInvalidRequestLineTest                                                   \
  MeekFrontedRequestsTest                                                      \
  MultiNdtTest                                                                 \
  NdtTest                                                                      \
  TcpConnectTest                                                               \
  TelegramTest                                                                 \
  WebConnectivityTest                                                          \
  WhatsappTest
do
  set -x
  m4 -D MK_TEST_NAME=$t -D "MK_NOW=$now" $package/BaseTest.m4 > $package/$t.java
  set +x
done

set -x
m4 -D "MK_NOW=$now" jni/wrappers/nettests.m4 | clang-format                    \
  > jni/wrappers/nettests.hpp
